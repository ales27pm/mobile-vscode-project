# .github/workflows/complete-build.yml
name: Complete Build Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '.gitignore'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - extension-only
          - mobile-only
      mobile_platform:
        description: 'Mobile platform to build'
        required: false
        default: 'android'
        type: choice
        options:
          - all
          - android
          - ios
      mobile_profile:
        description: 'EAS build profile'
        required: false
        default: 'development'
        type: choice
        options:
          - development
          - preview
          - production
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean
      skip_backend:
        description: 'Skip backend build'
        required: false
        default: false
        type: boolean
      skip_mobile:
        description: 'Skip mobile builds'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  ROOT_DIR: '${{ github.workspace }}'
  SKIP_MOBILE: ${{ github.event_name == 'workflow_dispatch' && inputs.skip_mobile }}

jobs:
  preflight:
    runs-on: ubuntu-latest
    name: Preflight Checks
    outputs:
      yarn_available: ${{ steps.check-yarn.outputs.yarn_available }}
      codegen_exists: ${{ steps.check-codegen.outputs.codegen_exists }}
      lint_exists: ${{ steps.check-lint.outputs.lint_exists }}
      package_vsix_exists: ${{ steps.check-package-vsix.outputs.package_vsix_exists }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js with Corepack
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          corepack: true

      - name: Enable Corepack
        run: corepack enable

      - name: Check Yarn availability
        id: check-yarn
        run: |
          if command -v yarn >/dev/null 2>&1; then
            echo "yarn_available=true" >> $GITHUB_OUTPUT
          else
            echo "Installing yarn via corepack..."
            corepack prepare yarn@1.22.22 --activate
            echo "yarn_available=true" >> $GITHUB_OUTPUT
          fi

      - name: Check for codegen script
        id: check-codegen
        run: |
          if jq -e '.scripts.codegen' package.json >/dev/null 2>&1; then
            echo "codegen_exists=true" >> $GITHUB_OUTPUT
          else
            echo "codegen_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for lint script
        id: check-lint
        run: |
          if jq -e '.scripts.lint' package.json >/dev/null 2>&1; then
            echo "lint_exists=true" >> $GITHUB_OUTPUT
          else
            echo "lint_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for package-vsix script
        id: check-package-vsix
        run: |
          if [ -f "scripts/package-vsix.sh" ]; then
            echo "package_vsix_exists=true" >> $GITHUB_OUTPUT
          else
            echo "package_vsix_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check .env file
        run: |
          if [ ! -f ".env" ]; then
            if [ -f ".env.example" ]; then
              echo "Creating .env from .env.example template..."
              cp .env.example .env
              echo "Note: Update LOCAL_IP in .env for mobile connectivity"
            else
              echo "Warning: No .env or .env.example file found"
            fi
          fi

  validate-and-test:
    runs-on: ubuntu-latest
    name: Validate & Test
    needs: preflight
    timeout-minutes: 15
    if: ${{ !inputs.skip_tests || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js with Corepack
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          corepack: true

      - name: Enable Corepack
        run: corepack enable

      - name: Get yarn cache directory
        id: yarn-cache-dir
        run: echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT

      - name: Cache yarn dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.yarn-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-engines --ignore-scripts

      - name: Generate GraphQL artifacts
        if: needs.preflight.outputs.codegen_exists == 'true'
        run: yarn codegen

      - name: TypeScript compilation check
        run: yarn tsc --noEmit

      - name: Run lint
        if: needs.preflight.outputs.lint_exists == 'true'
        run: yarn lint

      - name: Run backend tests
        run: |
          cd apps/backend
          npm test -- --coverage --passWithNoTests
          cd ../..

      - name: Upload test coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./apps/backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

  build-backend:
    runs-on: ubuntu-latest
    name: Build Backend
    needs: [preflight, validate-and-test]
    if: ${{ !inputs.skip_backend && (github.event.inputs.build_type == 'all' || github.event.inputs.build_type == 'extension-only' || github.event_name != 'workflow_dispatch') }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js with Corepack
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          corepack: true

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-engines --ignore-scripts

      - name: Generate GraphQL artifacts
        if: needs.preflight.outputs.codegen_exists == 'true'
        run: yarn codegen

      - name: Build backend
        run: yarn build:backend

      - name: Package VSIX (using package-vsix.sh if available)
        id: package-vsix
        run: |
          if [ -f "scripts/package-vsix.sh" ]; then
            echo "Using package-vsix.sh script..."
            chmod +x scripts/package-vsix.sh
            bash scripts/package-vsix.sh
            # Check if VSIX was created in root or apps/backend
            if [ -f "mobile-vscode-server.vsix" ]; then
              echo "VSIX created in root directory"
              echo "vsix_path=mobile-vscode-server.vsix" >> $GITHUB_OUTPUT
            elif [ -f "apps/backend/mobile-vscode-server.vsix" ]; then
              echo "VSIX created in apps/backend"
              echo "vsix_path=apps/backend/mobile-vscode-server.vsix" >> $GITHUB_OUTPUT
            else
              echo "VSIX not found, falling back to direct packaging"
              cd apps/backend
              npx @vscode/vsce package --no-dependencies --no-verify --out mobile-vscode-server.vsix
              echo "vsix_path=apps/backend/mobile-vscode-server.vsix" >> $GITHUB_OUTPUT
            fi
          else
            echo "package-vsix.sh not found, using direct packaging..."
            cd apps/backend
            npx @vscode/vsce package --no-dependencies --no-verify --out mobile-vscode-server.vsix
            echo "vsix_path=apps/backend/mobile-vscode-server.vsix" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: MobileVSCode ${{ github.ref_name }}
          body: |
            ## MobileVSCode Extension ${{ github.ref_name }}
            
            ### What's Included
            - GraphQL API server for mobile IDE
            - Real-time collaboration with Yjs
            - Git integration
            - File system watching
            - VS Code extension management
            
            ### Installation
            1. Download the `.vsix` file
            2. In VS Code: `Extensions` â†’ `...` â†’ `Install from VSIX`
            3. Restart VS Code
            
            ### Requirements
            - VS Code 1.80.0 or higher
            - Node.js 18+
            
            ### Notes
            - First run will generate pairing token
            - Configure HTTPS certificates for production use
          files: |
            ${{ steps.package-vsix.outputs.vsix_path }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: mobile-vscode-extension-${{ github.sha }}
          path: ${{ steps.package-vsix.outputs.vsix_path }}
          retention-days: 30
          if-no-files-found: error

  build-mobile:
    runs-on: ${{ matrix.runner }}
    name: Build Mobile (${{ matrix.platform }})
    needs: [preflight, validate-and-test]
    if: ${{ !env.SKIP_MOBILE && matrix.if_condition && (github.event_name != 'workflow_dispatch' || inputs.build_type == 'all' || inputs.build_type == 'mobile-only') }}
    strategy:
      matrix:
        include:
          - platform: android
            runner: ubuntu-latest
            if_condition: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.mobile_platform == 'all' || github.event.inputs.mobile_platform == 'android' }}
          - platform: ios
            runner: macos-latest
            if_condition: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.mobile_platform == 'all' || github.event.inputs.mobile_platform == 'ios' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js with Corepack
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          corepack: true

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --frozen-lockfile --ignore-engines --ignore-scripts

      - name: Generate GraphQL artifacts
        if: needs.preflight.outputs.codegen_exists == 'true'
        run: yarn codegen

      - name: Build shared packages
        run: |
          yarn workspaces foreach --all -p run build 2>/dev/null || true

      - name: Check EAS authentication
        id: check-eas-auth
        run: |
          if [ -n "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "Using EXPO_TOKEN from secrets"
            echo "eas_authenticated=true" >> $GITHUB_OUTPUT
          elif npx --yes eas whoami >/dev/null 2>&1; then
            echo "EAS already authenticated"
            echo "eas_authenticated=true" >> $GITHUB_OUTPUT
          else
            echo "EAS not authenticated and no EXPO_TOKEN provided"
            echo "eas_authenticated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create eas.json if needed
        if: steps.check-eas-auth.outputs.eas_authenticated == 'true'
        run: |
          cd apps/mobile
          
          # Create minimal eas.json if not exists using a cleaner approach
          if [ ! -f "eas.json" ]; then
            echo 'Creating eas.json...'
            cat > eas.json << 'EOF'
            {
              "cli": {
                "version": ">= 5.0.0"
              },
              "build": {
                "development": {
                  "developmentClient": true,
                  "distribution": "internal",
                  "android": {
                    "buildType": "apk"
                  },
                  "ios": {
                    "simulator": true
                  }
                },
                "preview": {
                  "distribution": "internal",
                  "android": {
                    "buildType": "apk"
                  }
                },
                "production": {}
              },
              "submit": {
                "production": {}
              }
            }
            EOF
            echo "eas.json created"
          else
            echo "eas.json already exists"
          fi
          cd ../..

      - name: Build with EAS (using npx as in deploy.sh)
        if: steps.check-eas-auth.outputs.eas_authenticated == 'true'
        run: |
          cd apps/mobile
          
          # Determine build command based on deploy.sh pattern
          PROFILE="${{ github.event.inputs.mobile_profile || 'development' }}"
          
          echo "Building for ${{ matrix.platform }} with profile: $PROFILE"
          
          # Use npx --yes eas as in deploy.sh script
          EAS_CMD=(npx --yes eas build --non-interactive --profile "$PROFILE" --platform "${{ matrix.platform }}")
          
          # Add output directory for local builds (if needed)
          if [ "${{ matrix.platform }}" = "android" ] && [ "$PROFILE" = "development" ]; then
            EAS_CMD+=(--output="./mobile-vscode-$PROFILE.apk")
          fi
          
          echo "Running: ${EAS_CMD[*]}"
          
          # Run EAS build with timeout and continue on error
          if ! "${EAS_CMD[@]}" --wait; then
            echo "EAS build failed, but continuing workflow..."
            echo "Build may have succeeded partially or timed out"
            # Don't fail the entire workflow, just warn
          fi
          
          # For iOS simulator builds, handle the output location
          if [ "${{ matrix.platform }}" = "ios" ] && [ "$PROFILE" = "development" ]; then
            echo "iOS development build completed"
            # iOS builds in EAS typically output to build directory
            if [ -d "ios/build" ]; then
              echo "iOS build artifacts in ios/build directory"
            fi
          fi
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Upload mobile artifacts
        if: steps.check-eas-auth.outputs.eas_authenticated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mobile-vscode-${{ matrix.platform }}-${{ github.event.inputs.mobile_profile || 'development' }}-${{ github.sha }}
          path: |
            apps/mobile/mobile-vscode-*.apk
            apps/mobile/mobile-vscode-*.ipa
            apps/mobile/ios/build/Build/Products/*.app
            apps/mobile/ios/build/*.app
            apps/mobile/android/app/build/outputs/**/*.apk
          retention-days: 30
          if-no-files-found: warn

  deploy-preview:
    runs-on: ubuntu-latest
    name: Deploy Preview
    if: github.event_name == 'pull_request'
    needs: [validate-and-test, build-backend, build-mobile]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate QR Code for Preview
        uses: crazy-max/ghaction-qrcode@v3
        with:
          text: |
            ðŸ“± MobileVSCode Preview Build
            
            Branch: ${{ github.head_ref }}
            Commit: ${{ github.sha }}
            
            Scan to open in Expo Go app!
            
            Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Server Endpoint: wss://mobile-vscode-${{ github.head_ref }}.example.com
          size: 300
          output: qr-preview.png

      - name: Comment Preview Links on PR
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const qrBase64 = fs.readFileSync('qr-preview.png', { encoding: 'base64' });
            
            const comment = {
              body: `## ðŸš€ MobileVSCode Preview Build\n\n` +
                    `**Branch:** ${context.payload.pull_request.head.ref}\n` +
                    `**Commit:** ${context.sha.substring(0, 7)}\n` +
                    `**Build:** #${context.runNumber}\n\n` +
                    `### ðŸ“¦ Built Artifacts:\n` +
                    `- [VS Code Extension (.vsix)](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts)\n` +
                    `- [Android APK](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts)\n\n` +
                    `### ðŸ“± Expo Preview\n` +
                    `![QR Code](data:image/png;base64,${qrBase64})\n\n` +
                    `_Scan with Expo Go app (Android/iOS)_\n\n` +
                    `### ðŸ”§ Deployment Instructions:\n` +
                    `1. Download the VSIX file and install in VS Code\n` +
                    `2. Start the MobileVSCode server from VS Code\n` +
                    `3. Download the Android APK on your device\n` +
                    `4. Pair your mobile device with the pairing token\n\n` +
                    `---\n` +
                    `*Generated by GitHub Actions*`
            };
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment.body
            });

  summary:
    runs-on: ubuntu-latest
    name: Build Summary
    needs: [preflight, validate-and-test, build-backend, build-mobile]
    if: always()
    
    steps:
      - name: Generate Build Summary
        run: |
          echo "## ðŸ“Š MobileVSCode Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ˆ Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Artifacts |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          
          # Preflight
          if [[ "${{ needs.preflight.result }}" == "success" ]]; then
            echo "| âœ… Preflight Checks | âœ… Success | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Preflight Checks | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Tests
          if [[ "${{ needs.validate-and-test.result }}" == "success" ]]; then
            echo "| âœ… Validate & Test | âœ… Success | [Coverage Report](https://app.codecov.io/gh/${{ github.repository }}) |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.validate-and-test.result }}" == "skipped" ]]; then
            echo "| âš ï¸ Validate & Test | âš ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Validate & Test | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Backend
          if [[ "${{ needs.build-backend.result }}" == "success" ]]; then
            echo "| âœ… VS Code Extension | âœ… Success | [Download VSIX](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.build-backend.result }}" == "skipped" ]]; then
            echo "| âš ï¸ VS Code Extension | âš ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ VS Code Extension | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Mobile
          MOBILE_BUILT=false
          if [[ "${{ needs.build-mobile.result }}" == "success" ]]; then
            MOBILE_BUILT=true
          fi
          
          if [[ "$MOBILE_BUILT" == "true" ]]; then
            echo "| âœ… Mobile App | âœ… Success | [Download APK/IPA](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts) |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event.inputs.skip_mobile }}" == "true" ]]; then
            echo "| âš ï¸ Mobile App | âš ï¸ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âŒ Mobile App | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo '1. **Install Extension:** Download the `.vsix` file and install in VS Code' >> $GITHUB_STEP_SUMMARY
          echo '2. **Start Server:** Run `Mobile VSCode: Start Server` from VS Code command palette' >> $GITHUB_STEP_SUMMARY
          echo "3. **Install Mobile App:** Download the APK/IPA file to your device" >> $GITHUB_STEP_SUMMARY
          echo "4. **Pair Device:** Open the mobile app and enter the pairing token from VS Code" >> $GITHUB_STEP_SUMMARY
          echo "5. **Development:** Use VS Code to edit files that sync to your mobile device in real-time" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Configuration Notes:" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Profile:** \`${{ github.event.inputs.mobile_profile || 'development' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms Built:** \`${{ github.event.inputs.mobile_platform || 'android' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Tests:** \`${{ github.event.inputs.skip_tests || false }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Backend:** \`${{ github.event.inputs.skip_backend || false }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Mobile:** \`${{ github.event.inputs.skip_mobile || false }}\`" >> $GITHUB_STEP_SUMMARY
